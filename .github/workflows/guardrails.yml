name: Guardrails (no BOM/FEFF, no conflict markers)

on:
  push:
  pull_request:

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Scan repository
        run: |
          python - <<'PY'
          import pathlib, sys, re

          bad = []
          binary_ext = re.compile(r"\.(png|jpg|jpeg|gif|ico|pdf|zip|woff2?)$", re.I)
          conflict = re.compile(rb"^(<<<<<<<|=======|>>>>>>>)", re.M)

          for p in pathlib.Path(".").rglob("*"):
              if not p.is_file():
                  continue
              s = str(p).replace("\\", "/")
              if s.startswith(".git/") or s.startswith(".venv/"):
                  continue
              if binary_ext.search(s):
                  continue

              data = p.read_bytes()

              if conflict.search(data):
                  bad.append(f"MERGE CONFLICT MARKERS: {s}")
              if b"\xEF\xBB\xBF" in data:
                  bad.append(f"UTF-8 BOM BYTES (EF BB BF): {s}")
              if "\ufeff".encode("utf-8") in data:
                  bad.append(f"U+FEFF CHARACTER: {s}")

          if bad:
              print("ERROR: Guardrails failed:")
              for x in bad:
                  print(" - " + x)
              sys.exit(1)

          print("OK: no BOM/FEFF and no conflict markers")
          PY